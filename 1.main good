#copy website 

install.packages("conflicted")
## open libraries


library(rinat)
library(sf)
library(dplyr)
library(tmap)
library(leaflet)
library(conflicted)

# load conflicted packages and set preferences fro library. 
conflict_prefer("filter", "dplyr", quiet = TRUE)
conflict_prefer("count", "dplyr", quiet = TRUE)
conflict_prefer("select", "dplyr", quiet = TRUE)
conflict_prefer("arrange", "dplyr", quiet = TRUE)
conflict_prefer("map", "maps", quiet=TRUE)
     
                
#transform the Squamish boundary to spatial coordinates.               
squamish.boundary.sf <- sf::st_read("Zoning_Classification.shp", quiet=TRUE) %>%
                                st_transform(4326)

 
  # ***try same thing with Squamish building permits***


#Use leaflet to plat the boundaries 
leaflet(squamish.boundary.sf[5])%>% 
  addTiles() %>% 
  addPolygons(weight = 1)

#Determine boundaries fo the Squamish area. 
squamish.boundary.bb <- st_bbox(squamish.boundary.sf)

# create objects with bounds
bounds <- c(49.63866, -123.26034, 49.87288, -123.01753)

#Get data from inaturalist project in Squamish. 
amphibians <-get_inat_obs (taxon_name = "Amphibia", bounds = bounds, year = 2020, 
                         maxresults = 1000)

#see some fo the charasteristics of the taxon. 
dim(amphibians)
glimpse(amphibians)

# see what species and how many individuals. 
sp.rep <- amphibians%>%
  group_by(scientific_name) %>%
  summarise(species = n())
print(spp_per_group)

#convert amphibians data into shp file
amphibians.sf <- amphibians%>% 
  select(longitude, latitude, datetime, common_name, 
         scientific_name) %>% 
  st_as_sf(coords=c("longitude", "latitude"), crs=4326) # geomtry : POINT

#check if only the four columns we are interested in are kept. 
dim(amphibians.sf)

#check of all our observations fall within the area #not needed normally 
# some points fall outside of boundaries. 

amphibians.out.bound.sf <- amphibians.sf %>% 
  st_intersection(squamish.boundary.sf)
nrow(amphibians.out.bound)

#Provide 
amphibians.popup.sf <- amphibians.sf %>% 
  mutate(popup_html = paste0("<p><b>", common_name, "</b><br/>",
                             "<i>", scientific_name, "</i></p>",
                             "<p>Observed: ", datetime, "<br/>",
                            "style=width:100%;/></p>")
  )

#map results using leaflet tools

htmltools::p("iNaturalist Observations in Squamish",
             htmltools::br(),
             amphibians.sf$datetime %>% 
               as.Date() %>% 
               range(na.rm = TRUE) %>% 
               paste(collapse = " to "),
             style = "font-weight:bold; font-size:110%")
             
             
leaflet(squamish.boundary.sf) %>% 
    addProviderTiles("Esri.WorldStreetMap") %>% 
    addPolygons(weight = 1) %>% 
    addCircleMarkers(data = amphibians.popup.sf,
                                popup = ~popup_html, 
                                radius = 2, color = "red", weight = 3)
                                
=============== include Squamish building permits =========================

# Same protocal as above. 

squamish.boundary.sf <- st_read("Zoning_Classification.shp", quiet=TRUE) %>%
  st_transform(4326)

#Use leaflet to plat the boundaries 
leaflet(squamish.boundary.sf[5])%>% 
  addTiles() %>% 
  addPolygons(weight = 1)

#Determine boundaries fo the Squamish area. 
squamish.boundary.bb <- st_bbox(squamish.boundary.sf)

# create objects with bounds
bounds <- c(49.63866, -123.26034, 49.87288, -123.01753)

#Builidng permits in Squamish 
build.perm <- sf::st_read("Building_Permits.shp copy", quiet=TRUE)

str(build.perm)

build.perm.sf <- build.perm%>% 
  select(, latitude, datetime, common_name, 
         scientific_name) %>% 
  st_as_sf(coords=c("longitude", "latitude"), crs=4326)
                                
                                
                                
                                
